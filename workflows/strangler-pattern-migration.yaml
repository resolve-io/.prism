# <!-- Powered by PRISM Core -->
workflow:
  id: strangler-pattern-migration
  name: PRISM Strangler Pattern Controller Migration
  description: >-
    Complete TDD-driven workflow for migrating controllers from express-web-api
    to actions.api using the strangler pattern. Follows PRISM methodology:
    Predictability (structured process), Resilience (TDD), Intentionality (clean code),
    Sustainability (craftsmanship), and Maintainability (domain-driven design).
  type: brownfield
  version: 1.0.0
  project_types:
    - api-migration
    - legacy-modernization
    - strangler-pattern

  sequence:
    - step: tdd_setup
      agent: dev
      action: task
      uses: strangler-pattern
      notes: |
        Execute TDD strangler pattern analysis:
        Maps to task command in skills/dev/SKILL.md
        Loads skills/dev/reference/tasks/strangler-pattern.md

        Process:
        - Provide endpoint URL and test credentials
        - Follow authentication discovery in guide
        - Capture authenticated endpoint responses
        - Record performance baseline

    - step: validation
      agent: dev
      action: execute-checklist
      uses: strangler-migration-checklist
      requires: tdd_setup
      notes: |
        Comprehensive migration validation:
        Maps to execute-checklist command in skills/dev/SKILL.md
        Uses strangler-migration-checklist from checklists/
        Interactive or comprehensive mode

    - step: integration_tests
      agent: dev
      action: develop
      creates: endpoint_tests.cs
      requires: validation
      location: c:\Dev\actions.api\tests\Integration.Tests\Endpoints\
      notes: |
        Create actions.api integration tests (RED state):
        Maps to develop command in skills/dev/SKILL.md
        Loads skills/dev/reference/tdd-methodology.md

        Implementation:
        - Follow existing endpoint test patterns
        - Use ActionsApiFactory, DatabaseFixture, SmtpFixture
        - Test against captured response structure
        - Tests must FAIL initially (RED state)

    - step: implementation
      agent: dev
      action: develop
      creates: new_endpoint_files
      requires: integration_tests
      notes: |
        Implement new actions.api endpoint (GREEN state):
        Maps to develop command in skills/dev/SKILL.md
        Loads skills/dev/reference/coding-standards.md

        Implementation:
        - Follow Request/Handler/Service pattern from guide
        - Use IDbContextResolver and AbstractValidator<T>
        - Register in EndpointRegistrar.cs and ServiceRegistrar.cs
        - Make tests pass (GREEN state)

    - step: strangler_integration
      agent: dev
      action: develop
      updates: express_web_api_controller
      requires: implementation
      notes: |
        Set up strangler integration in express-web-api:
        Maps to develop command in skills/dev/SKILL.md

        Implementation:
        - Follow 4-line controller pattern from guide
        - Create lazy-loaded services in controller
        - Configure feature flag routing

    - step: dual_path_testing
      agent: dev
      action: validate
      requires: strangler_integration
      notes: |
        Run comprehensive dual-path validation:
        Maps to validate command in skills/dev/SKILL.md

        Validation:
        - Execute full Integration.Tests suite
        - Compare legacy vs new endpoint responses
        - Verify performance and behavior equivalence

    - step: production_readiness
      agent: dev
      action: develop
      requires: dual_path_testing
      notes: |
        Complete migration process:
        Maps to develop command in skills/dev/SKILL.md

        Final steps:
        - Monitor production deployment
        - Validate business metrics
        - Plan legacy endpoint removal

artifacts:
  created:
    - location: c:\Dev\actions.api\tests\Integration.Tests\Endpoints\[Controller]EndpointTests.cs
      description: Integration tests following actions.api patterns
    - location: TestEnvironment/Data/[Controller]TestData.cs  
      description: Test data and captured response fixtures
    - location: actions.api endpoint files
      description: New minimal API endpoints with handlers and services
    
  required:
    - strangler-pattern.md (implementation task)
    - strangler-migration-checklist.md (validation checklist)
    - Running legacy endpoint URL
    - actions.api test infrastructure

validation:
  checklist: strangler-migration-checklist
  success_criteria:
    - All integration tests pass
    - Legacy behavior preserved exactly
    - No regression in existing tests
    - Production-ready strangled endpoint

notes: |
  This workflow orchestrates the complete strangler pattern migration process:
  
  1. **TDD Foundation**: Follows behavior-first methodology
  2. **Integration Testing**: Leverages existing actions.api test infrastructure  
  3. **Safe Migration**: Gradual traffic switching with rollback capability
  4. **Quality Assurance**: Comprehensive validation at each step
  
  Use for each controller being migrated to ensure consistent, safe transformation.

  **Example Story Structure:**
  
  # [Controller] Strangler Pattern Migration Story

  ## ðŸŽ¯ Task:
  **As a** [stakeholder role]
  **I want to** migrate the [Controller] [endpoint] from express-web-api to actions.api using the strangler pattern
  **So that** we can modernize our [domain] infrastructure while maintaining zero downtime and preserving existing functionality
  
  ## âœ… Acceptance Criteria:
  
  ### Phase 1: Real-World Behavior Capture with Authentication Discovery
  - [ ] **WHEN** I test the live [Controller] endpoint at `http://localhost:52928/Api/[controller]/[method]`
  - [ ] **THEN** I discover working authentication using password grant:
    ```powershell
    $authBody = @{
        grant_type = "password"
        client_id = "RDTest"
        username = "SuperAdmin"
        password = "R3solv3!"
    }
    $token = (Invoke-RestMethod -Uri "http://localhost:52928/api/Auth/token" -Method Post -Body $authBody).access_token
    ```
  - [ ] **AND** I capture complete JSON responses with authentication:
    ```json
    {
      "[response structure based on captured data]": "[actual values]"
    }
    ```
  - [ ] **AND** I test error scenarios (401, 403, 404, 500) and save responses
  - [ ] **AND** I record response times for performance baseline
  
  ### Phase 2: Test Creation (RED)
  - [ ] **WHEN** I create integration tests in `c:\Dev\actions.api\tests\Integration.Tests\Endpoints\[Controller]EndpointTests.cs`
  - [ ] **THEN** tests follow existing patterns using `ActionsApiFactory`, `DatabaseFixture`, `SmtpFixture`
  - [ ] **AND** tests use `[Collection(nameof(DefaultWebApplicationCollection))]` attribute
  - [ ] **AND** all tests initially FAIL (RED state) before implementation
  - [ ] **AND** test assertions match exact captured response formats including authentication flow
  - [ ] **CRITICAL** I create response equivalence test validating seeded data produces captured structure:
    ```csharp
    [Fact]
    public async Task [Controller]_ShouldReturn_ExactCapturedResponseStructure()
    {
        // Arrange: Seed test data to match captured response expectations
        // Act: Call new actions.api endpoint with seeded data
        // Assert: JSON structure matches captured response exactly
        var expectedJson = LoadCapturedResponse();
        var actualResponse = await CallNewEndpoint();
        AssertJsonStructureEquivalence(expectedJson, actualResponse);
    }
    ```
  
  ### Phase 3: Implementation (GREEN)
  - [ ] **WHEN** I implement the new [Controller] endpoint in actions.api
  - [ ] **THEN** it follows Command/Request â†’ Handler â†’ Service pattern
  - [ ] **AND** preserves exact response structure from captured behavior
  - [ ] **AND** integrates with existing auth schemes and database context
  - [ ] **AND** all tests pass with behavior exactly matching captured responses
  - [ ] **CRITICAL** Database seeding validation: Verify seeded test data produces exact captured JSON structure
  - [ ] **ESSENTIAL** Response structure equivalence: New implementation + seeded data = captured behavior
  
  ### Phase 4: Strangler Integration
  - [ ] **WHEN** I set up express-web-api controller modification
  - [ ] **THEN** add feature flag routing in express-web-api controller
  - [ ] **AND** configure gradual traffic switching via feature flags
  - [ ] **AND** enable dual-path testing capability with fallback to legacy
  
  ### Phase 5: Production Validation
  - [ ] **WHEN** I run the complete Integration.Tests suite
  - [ ] **THEN** all existing tests continue to pass (no regressions)
  - [ ] **AND** new [Controller] tests pass consistently
  - [ ] **AND** response equivalence verified including authentication and exact JSON structure
  - [ ] **AND** performance matches or exceeds legacy system baseline
  - [ ] **CRITICAL** Seeded data validation: Test data produces identical response structure to captured behavior
  - [ ] **ESSENTIAL** End-to-end verification: New endpoint with seeded data = captured legacy response
  
  **Story template can be customized for any controller migration.**