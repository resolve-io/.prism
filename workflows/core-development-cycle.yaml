# PRISM Core Development Cycle Workflow
# Complete workflow from planning through deployment
# Supports both greenfield and brownfield projects

# ============================================================================
# STORY CONTEXT PATTERN
# ============================================================================
#
# This workflow creates a story file in the draft_story step and ALL subsequent
# steps work on that SAME story file throughout the entire lifecycle:
#
#   draft_story → Creates story file with SM-determined naming
#                 Example: docs/stories/platform-1.auth-improvements-2.md
#                 └─ Output: story_file = actual path to created file
#                     ↓
#   All subsequent steps → Use: $draft_story.output.story_file
#                           (risk_assessment, test_design, validate_story,
#                            implement_tasks, qa_review, address_review_issues,
#                            update_gate)
#
# The story file is the SINGLE SOURCE OF TRUTH that flows through all phases:
# Planning → Development → Review → Completion
#
# TOKEN RESOLUTION:
# - {epic} and {story} in documentation are TEMPLATE PLACEHOLDERS showing
#   the file naming pattern, NOT runtime variables
# - The SM agent determines actual epic/story identifiers during draft execution
# - The actual file path is captured in draft_story.output.story_file
# - All subsequent steps receive the concrete path via $draft_story.output.story_file
#
# ============================================================================

workflow:
  id: core-development-cycle
  name: PRISM Core Development Cycle
  description: >-
    Complete development workflow supporting both greenfield (new) and brownfield (existing codebase)
    projects. Follows PRISM methodology: Predictability (PSP/TSP), Resilience (TDD/XP),
    Intentionality (Clean Code), Sustainability (Agile), and Maintainability (DDD).
  version: 1.3.0
  type: universal  # Supports both greenfield and brownfield

  # Companion documentation with visual diagrams, scenarios, and decision trees
  documentation: workflows/core-development-cycle.md

  # Main development sequence
  sequence:
    # ============================================================================
    # PLANNING PHASE
    # ============================================================================

    - step: review_previous_notes
      agent: sm
      action: planning-review
      description: Review previous story dev/QA notes for context
      notes: |
        Story Master reviews completed work to inform next story
        Maps to planning-review command in skills/sm/SKILL.md

    - step: draft_story
      agent: sm
      action: draft
      requires: review_previous_notes
      description: Draft next story from sharded epic + architecture
      output:
        story_file: "Path to created story file (e.g., docs/stories/epic-1.story-3.md)"
      notes: |
        Maps to draft command in skills/sm/SKILL.md
        Command: *draft (no parameters)

        Creates story in docs/stories/ following template
        Applies PSP/PROBE sizing methodology

        The SM agent determines the epic and story identifiers based on:
        - Existing epic context from sharded epic document
        - Next available story number in sequence
        - Story naming convention: docs/stories/{epic-id}.{story-id}.md

        CRITICAL: The actual story file path is returned in output.story_file
        and ALL subsequent steps reference this via $draft_story.output.story_file

        Example: If SM creates "docs/stories/platform-1.auth-improvements-2.md"
        then story_file = "docs/stories/platform-1.auth-improvements-2.md"

    - step: risk_assessment
      agent: qa
      action: risk-profile
      optional: true
      condition: high_risk_story
      requires: draft_story
      input:
        story_file: $draft_story.output.story_file
      description: Assess risk for high-risk stories (brownfield focus)
      notes: |
        OPTIONAL: Run for high-risk stories (legacy code, complex integrations)
        Maps to risk-profile command (short: *risk) in skills/qa/SKILL.md
        Command: *risk {story}
        - Parameter {story} receives value from: $draft_story.output.story_file
        Output: docs/qa/assessments/{epic}.{story}-risk-{YYYYMMDD}.md

        Uses story file from draft_story step as input.

        Brownfield Risk Analysis:
        - Regression probability × impact scoring
        - Legacy dependency mapping
        - Breaking change potential
        - Data migration complexity

    - step: test_design
      agent: qa
      action: test-design
      optional: true
      condition: high_risk_story
      requires: risk_assessment
      input:
        story_file: $draft_story.output.story_file
      description: Create test strategy for high-risk stories
      notes: |
        OPTIONAL: Run after risk assessment for high-risk stories
        Maps to test-design command in skills/qa/SKILL.md
        Command: *design {story}
        - Parameter {story} receives value from: $draft_story.output.story_file
        References skills/qa/reference/test-framework.md for test levels
        Output: docs/qa/assessments/{epic}.{story}-test-design-{YYYYMMDD}.md

        Uses story file from draft_story step as input.

        Creates test strategy:
        - Regression test requirements
        - Integration test coverage
        - Performance baseline validation
        - Feature flag testing scenarios

    - step: validate_story
      agent: po
      action: validate-story-draft
      optional: true
      requires: draft_story
      input:
        story_file: $draft_story.output.story_file
      description: PO validates story against artifacts (optional)
      notes: |
        OPTIONAL: User can request PO validation before approval
        Maps to validate-story-draft command in skills/po/SKILL.md
        Command: *validate-story-draft {story}
        - Parameter {story} receives value from: $draft_story.output.story_file
        Validates against PRD, architecture, acceptance criteria

        Uses story file from draft_story step as input.

    - step: user_approval
      description: User reviews and approves story draft
      requires: validate_story
      manual: true
      notes: |
        User checkpoint: Review story, request changes or approve
        If changes needed, return to draft_story step
        If approved, proceed to development

    # ============================================================================
    # DEVELOPMENT PHASE
    # ============================================================================

    - step: implement_tasks
      agent: dev
      action: develop-story
      requires: user_approval
      input:
        story_file: $draft_story.output.story_file
      description: Sequential task execution with TDD
      notes: |
        Maps to develop-story command in skills/dev/SKILL.md
        Command: *develop-story (works on current story file in context)
        References skills/dev/reference/development-workflow.md for process

        CRITICAL: Developer works on the story file created in draft_story step.
        The story file is provided via input.story_file variable.

        Development Process (all handled by develop-story):
        1. Read story file from docs/stories/ directory
        2. Set PSP tracking Started timestamp
        3. For each task: Read → Implement → Test → Validate → Mark complete
        4. Run all validations (tests, linting, type checking)
        5. Update story File List with all changes
        6. Mark story as 'Ready for Review' with completion notes
        7. Follow PRISM principles (Predictability, Resilience, Intentionality,
           Sustainability, Maintainability)
        8. Apply TDD: Write tests first, make them pass, refactor

        The develop-story command is comprehensive and handles validation
        and marking ready for review as part of its workflow.

    # ============================================================================
    # REVIEW PHASE
    # ============================================================================

    - step: user_verification
      description: User verifies implementation
      requires: implement_tasks
      manual: true
      notes: |
        User checkpoint: Choose next action
        Options:
        1. Request QA review (recommended for brownfield)
        2. Approve without QA (greenfield, simple changes)
        3. Request fixes (returns to implement_tasks)

    - step: qa_review
      agent: qa
      action: review
      optional: true
      requires: user_verification
      input:
        story_file: $draft_story.output.story_file
      description: Comprehensive quality review with gate decision
      notes: |
        OPTIONAL: User can request comprehensive QA review
        Maps to review command in skills/qa/SKILL.md
        Command: *review {story}
        - Parameter {story} receives value from: $draft_story.output.story_file

        Reviews the story file created in draft_story step.

        Outputs:
        - Updates QA Results section in story file
        - Creates gate file: docs/qa/gates/{epic}.{story}-{slug}.yml

        Brownfield Analysis:
        - API breaking changes validation
        - Data migration safety
        - Performance regression check
        - Integration point validation
        - Feature flag logic verification
        - Dependency impact assessment

    - step: address_review_issues
      agent: dev
      action: review-qa
      optional: true
      requires: qa_review
      input:
        story_file: $draft_story.output.story_file
      description: Fix issues identified in QA review
      notes: |
        OPTIONAL: Only if QA review identified issues
        Maps to review-qa command in skills/dev/SKILL.md
        Command: *review-qa (works on current story file)

        Continues working on the same story file from draft_story step.
        Returns to qa_review after fixes.

    - step: verify_regression_and_lint
      description: CRITICAL - Verify all tests and linting pass
      requires: [user_verification, qa_review]
      manual: true
      notes: |
        CRITICAL CHECKPOINT: User must verify before committing
        - All regression tests passing
        - All linting passing
        - All type checks passing
        - Build succeeds

    - step: commit_changes
      description: COMMIT YOUR CHANGES
      requires: verify_regression_and_lint
      manual: true
      notes: |
        CRITICAL: Commit all changes before marking story done
        Use git to commit with meaningful message
        Include PRISM attribution in commit message

    # ============================================================================
    # COMPLETION PHASE
    # ============================================================================

    - step: update_gate
      agent: qa
      action: gate
      optional: true
      requires: commit_changes
      input:
        story_file: $draft_story.output.story_file
      description: Update gate status after fixes
      notes: |
        OPTIONAL: Update gate file with final decision
        Maps to gate command in skills/qa/SKILL.md
        Command: *gate {story}
        - Parameter {story} receives value from: $draft_story.output.story_file
        Updates: docs/qa/gates/{epic}.{story}-{slug}.yml

        Updates gate for the story file created in draft_story step.

        Gate Decisions:
        - PASS: All criteria met, safe to merge
        - PASS WITH CONCERNS: Minor issues documented
        - FAIL: Critical issues must be fixed
        - WAIVED: Issues acknowledged and accepted

    - step: mark_story_done
      description: Mark story as done
      requires: commit_changes
      manual: true
      notes: |
        Final step: Mark story as complete
        Story status: 'Done'
        Ready to pull next story from backlog

# ============================================================================
# ARTIFACTS
# ============================================================================

artifacts:
  created:
    - location: "docs/stories/{epic}.{story}.md (template pattern)"
      actual: "Determined by SM agent during draft, e.g., docs/stories/platform-1.auth-2.md"
      template: story-template.md
      description: User story with tasks, acceptance criteria, dev notes
      agent: sm
      notes: |
        {epic} and {story} are template placeholders.
        SM agent determines actual values during execution.

    - location: "docs/qa/assessments/{epic}.{story}-risk-{YYYYMMDD}.md (template pattern)"
      actual: "Generated by QA agent, e.g., docs/qa/assessments/platform-1.auth-2-risk-20250124.md"
      template: risk-assessment-template.md
      description: Risk profile with probability × impact scoring
      agent: qa
      optional: true
      notes: |
        {epic}.{story} extracted from story file path.
        {YYYYMMDD} generated by QA skill as current date.

    - location: "docs/qa/assessments/{epic}.{story}-test-design-{YYYYMMDD}.md (template pattern)"
      actual: "Generated by QA agent, e.g., docs/qa/assessments/platform-1.auth-2-test-design-20250124.md"
      template: test-design-template.md
      description: Test strategy and coverage plan
      agent: qa
      optional: true
      notes: |
        {epic}.{story} extracted from story file path.
        {YYYYMMDD} generated by QA skill as current date.

    - location: "docs/qa/gates/{epic}.{story}-{slug}.yml (template pattern)"
      actual: "Generated by QA agent, e.g., docs/qa/gates/platform-1.auth-2-comprehensive-review.yml"
      description: Quality gate decision (PASS/CONCERNS/FAIL/WAIVED)
      agent: qa
      optional: true
      notes: |
        {epic}.{story} extracted from story file path.
        {slug} generated by QA skill based on review type.

  required:
    - docs/prd.md (or equivalent requirements)
    - docs/architecture.md (system design)
    - Sharded epic with story sequence

# ============================================================================
# VALIDATION
# ============================================================================

validation:
  success_criteria:
    - All acceptance criteria met
    - All tests passing (unit, integration, e2e)
    - Linting and type checking passing
    - Code review approved (if requested)
    - QA gate decision (if requested)
    - Changes committed to version control
    - Story marked as Done

  quality_gates:
    - name: Development Complete
      criteria:
        - All tasks marked complete
        - All tests passing
        - File List updated
        - Completion notes documented

    - name: Review Approved
      criteria:
        - User verified implementation
        - QA review passed (if requested)
        - All identified issues addressed

    - name: Ready to Deploy
      criteria:
        - Regression tests passing
        - Linting passing
        - Changes committed
        - Gate decision recorded (if applicable)

# ============================================================================
# DECISION TREES
# ============================================================================

decision_trees:
  project_type:
    question: "Do you have a large codebase or monorepo?"
    branches:
      - condition: "Yes"
        recommendation: "PRD-First Approach"
        notes: "Create PRD → Document only affected areas"

      - condition: "No - codebase well-known"
        recommendation: "PRD-First Approach"

      - condition: "No - codebase unknown"
        recommendation: "Document-First Approach"

  brownfield_workflow:
    question: "Is this a major enhancement affecting multiple systems?"
    branches:
      - condition: "Yes"
        recommendation: "Full Brownfield Workflow"
        required_steps:
          - risk_assessment
          - test_design
          - qa_review
        notes: "ALWAYS run Test Architect risk + design first"

      - condition: "No - more than simple bug fix"
        recommendation: "Brownfield Story Workflow"
        required_steps:
          - risk_assessment  # If touching integration points
          - qa_review
        notes: "Run *risk if touching critical paths"

      - condition: "No - simple bug fix"
        recommendation: "Standard Story Workflow"
        optional_steps:
          - qa_review  # Still recommended
        notes: "QA review recommended for quality assurance"

  legacy_code_decision:
    question: "Does the change touch legacy code?"
    branches:
      - condition: "Yes"
        recommendation: "Test Architect MANDATORY"
        required_steps:
          - risk_assessment  # Identify regression potential
          - test_design      # Plan test coverage
          - qa_review        # Validate no breakage

      - condition: "No"
        recommendation: "Test Architect RECOMMENDED"
        optional_steps:
          - qa_review  # Ensure quality standards

# ============================================================================
# BROWNFIELD SPECIFIC GUIDANCE
# ============================================================================

brownfield:
  when_mandatory:
    - Large codebase or monorepo modifications
    - Changes touching legacy code
    - API modifications or integrations
    - Data migrations
    - Performance-critical changes
    - Security-sensitive changes
    - Multiple system integrations

  required_steps:
    - risk_assessment: "BEFORE development starts"
    - test_design: "BEFORE writing code"
    - qa_review: "BEFORE merging"

  testing_standards:
    regression_coverage:
      - "Every touched legacy module needs tests"
      - "Minimum 80% coverage of affected code paths"
      - "Critical paths require 100% coverage"

    performance_baselines:
      - "Must maintain or improve current metrics"
      - "Document acceptable degradation thresholds"
      - "Include performance tests in CI/CD"

    rollback_procedures:
      - "Every change needs a rollback plan"
      - "Rollback must be tested"
      - "Document rollback triggers and process"

    feature_flags:
      - "All risky changes behind toggles"
      - "Test both enabled and disabled states"
      - "Document flag removal plan"

# ============================================================================
# PROGRESSIVE DISCLOSURE REFERENCES
# ============================================================================

progressive_disclosure:
  skill_structure:
    - level: core
      files:
        - skills/{agent}/SKILL.md
      size: "<2k tokens"
      purpose: "List available commands, quick reference"

    - level: detailed
      files:
        - skills/{agent}/reference/commands.md
        - skills/{agent}/reference/{topic}.md
      size: "Variable"
      purpose: "Detailed command instructions, loaded as needed"

    - level: specialized
      files:
        - skills/{agent}/reference/tasks/{task-name}.md
        - skills/{agent}/reference/checklists/{checklist-name}.md
      size: "Variable"
      purpose: "Specific task instructions, loaded when referenced"

  loading_pattern:
    - "Workflow references action (e.g., create-architecture)"
    - "Loads skills/{agent}/SKILL.md (core commands)"
    - "Progressively loads reference/*.md as needed"
    - "Only loads what's necessary for current step"

# ============================================================================
# NOTES
# ============================================================================

notes: |
  This workflow orchestrates the complete PRISM development cycle with flexibility
  for both greenfield and brownfield projects.

  KEY PRINCIPLES:

  1. **Adaptive Workflow**: Optional steps based on project risk and complexity
  2. **Progressive Disclosure**: Skills load detailed instructions as needed
  3. **Brownfield Safety**: Test Architect involvement for legacy code changes
  4. **Quality Gates**: Clear checkpoints with user control
  5. **PRISM Methodology**: All five principles applied throughout

  SKILL COMMAND MAPPING:

  All workflow actions map to commands defined in skills/{agent}/SKILL.md:
  - sm: draft, planning-review, decompose, estimate, resize
  - po: story-checklist, create-story, validate-story-draft, shard-doc
  - dev: develop-story, run-tests
  - qa: risk-profile, test-design, review, gate
  - architect: document-project, create-architecture

  Each command loads its core definition from SKILL.md, then progressively loads
  detailed instructions from reference/ directory as needed.

  BROWNFIELD DECISION FLOW:

  - High-risk story? → *risk + *design BEFORE coding
  - Before merge? → *review for comprehensive QA
  - After fixes? → *gate to update decision

  Use this workflow as the foundation for all PRISM development, adapting the
  optional steps based on project needs and risk assessment.

  STORY CONTEXT: All steps after draft_story receive the story file path via
  input.story_file parameter, ensuring the entire workflow works on the same
  story file from creation through completion.

version: 1.3.0
