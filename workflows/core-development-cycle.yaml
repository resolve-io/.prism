# PRISM Core Development Cycle Workflow
# Complete workflow from planning through deployment
# Supports both greenfield and brownfield projects

workflow:
  id: core-development-cycle
  name: PRISM Core Development Cycle
  description: >-
    Complete development workflow supporting both greenfield (new) and brownfield (existing codebase)
    projects. Follows PRISM methodology: Predictability (PSP/TSP), Resilience (TDD/XP),
    Intentionality (Clean Code), Sustainability (Agile), and Maintainability (DDD).
  version: 1.1.0
  type: universal  # Supports both greenfield and brownfield

  # Companion documentation with visual diagrams, scenarios, and decision trees
  documentation: workflows/core-development-cycle.md

  # Main development sequence
  sequence:
    # ============================================================================
    # PLANNING PHASE
    # ============================================================================

    - step: review_previous_notes
      agent: sm
      action: planning-review
      description: Review previous story dev/QA notes for context
      notes: |
        Story Master reviews completed work to inform next story
        Maps to planning-review command in skills/sm/SKILL.md

    - step: draft_story
      agent: sm
      action: draft
      requires: review_previous_notes
      description: Draft next story from sharded epic + architecture
      notes: |
        Maps to draft command in skills/sm/SKILL.md
        Creates story in docs/stories/ following template
        Applies PSP/PROBE sizing methodology

    - step: risk_assessment
      agent: qa
      action: risk-profile
      optional: true
      condition: high_risk_story
      requires: draft_story
      description: Assess risk for high-risk stories (brownfield focus)
      notes: |
        OPTIONAL: Run for high-risk stories (legacy code, complex integrations)
        Maps to risk-profile command (short: *risk) in skills/qa/SKILL.md
        Output: docs/qa/assessments/{epic}.{story}-risk-{YYYYMMDD}.md

        Brownfield Risk Analysis:
        - Regression probability × impact scoring
        - Legacy dependency mapping
        - Breaking change potential
        - Data migration complexity

    - step: test_design
      agent: qa
      action: test-design
      optional: true
      condition: high_risk_story
      requires: risk_assessment
      description: Create test strategy for high-risk stories
      notes: |
        OPTIONAL: Run after risk assessment for high-risk stories
        Maps to test-design command in skills/qa/SKILL.md
        References skills/qa/reference/test-framework.md for test levels
        Output: docs/qa/assessments/{epic}.{story}-test-design-{YYYYMMDD}.md

        Creates test strategy:
        - Regression test requirements
        - Integration test coverage
        - Performance baseline validation
        - Feature flag testing scenarios

    - step: validate_story
      agent: po
      action: validate-story-draft
      optional: true
      requires: draft_story
      description: PO validates story against artifacts (optional)
      notes: |
        OPTIONAL: User can request PO validation before approval
        Maps to validate-story-draft command in skills/po/SKILL.md
        Validates against PRD, architecture, acceptance criteria

    - step: user_approval
      description: User reviews and approves story draft
      requires: validate_story
      manual: true
      notes: |
        User checkpoint: Review story, request changes or approve
        If changes needed, return to draft_story step
        If approved, proceed to development

    # ============================================================================
    # DEVELOPMENT PHASE
    # ============================================================================

    - step: implement_tasks
      agent: dev
      action: develop-story
      requires: user_approval
      description: Sequential task execution with TDD
      notes: |
        Maps to develop-story command in skills/dev/SKILL.md
        References skills/dev/reference/development-workflow.md for process

        Development Process (all handled by develop-story):
        1. Set PSP tracking Started timestamp
        2. For each task: Read → Implement → Test → Validate → Mark complete
        3. Run all validations (tests, linting, type checking)
        4. Update story File List with all changes
        5. Mark story as 'Ready for Review' with completion notes
        6. Follow PRISM principles (Predictability, Resilience, Intentionality,
           Sustainability, Maintainability)
        7. Apply TDD: Write tests first, make them pass, refactor

        The develop-story command is comprehensive and handles validation
        and marking ready for review as part of its workflow.

    # ============================================================================
    # REVIEW PHASE
    # ============================================================================

    - step: user_verification
      description: User verifies implementation
      requires: implement_tasks
      manual: true
      notes: |
        User checkpoint: Choose next action
        Options:
        1. Request QA review (recommended for brownfield)
        2. Approve without QA (greenfield, simple changes)
        3. Request fixes (returns to implement_tasks)

    - step: qa_review
      agent: qa
      action: review
      optional: true
      requires: user_verification
      description: Comprehensive quality review with gate decision
      notes: |
        OPTIONAL: User can request comprehensive QA review
        Maps to review command in skills/qa/SKILL.md

        Outputs:
        - Updates QA Results section in story file
        - Creates gate file: docs/qa/gates/{epic}.{story}-{slug}.yml

        Brownfield Analysis:
        - API breaking changes validation
        - Data migration safety
        - Performance regression check
        - Integration point validation
        - Feature flag logic verification
        - Dependency impact assessment

    - step: address_review_issues
      agent: dev
      action: review-qa
      optional: true
      requires: qa_review
      description: Fix issues identified in QA review
      notes: |
        OPTIONAL: Only if QA review identified issues
        Maps to review-qa command in skills/dev/SKILL.md
        Returns to qa_review after fixes

    - step: verify_regression_and_lint
      description: CRITICAL - Verify all tests and linting pass
      requires: [user_verification, qa_review]
      manual: true
      notes: |
        CRITICAL CHECKPOINT: User must verify before committing
        - All regression tests passing
        - All linting passing
        - All type checks passing
        - Build succeeds

    - step: commit_changes
      description: COMMIT YOUR CHANGES
      requires: verify_regression_and_lint
      manual: true
      notes: |
        CRITICAL: Commit all changes before marking story done
        Use git to commit with meaningful message
        Include PRISM attribution in commit message

    # ============================================================================
    # COMPLETION PHASE
    # ============================================================================

    - step: update_gate
      agent: qa
      action: gate
      optional: true
      requires: commit_changes
      description: Update gate status after fixes
      notes: |
        OPTIONAL: Update gate file with final decision
        Maps to gate command in skills/qa/SKILL.md
        Updates: docs/qa/gates/{epic}.{story}-{slug}.yml

        Gate Decisions:
        - PASS: All criteria met, safe to merge
        - PASS WITH CONCERNS: Minor issues documented
        - FAIL: Critical issues must be fixed
        - WAIVED: Issues acknowledged and accepted

    - step: mark_story_done
      description: Mark story as done
      requires: commit_changes
      manual: true
      notes: |
        Final step: Mark story as complete
        Story status: 'Done'
        Ready to pull next story from backlog

# ============================================================================
# ARTIFACTS
# ============================================================================

artifacts:
  created:
    - location: docs/stories/{epic}.{story}.md
      template: story-template.md
      description: User story with tasks, acceptance criteria, dev notes
      agent: sm

    - location: docs/qa/assessments/{epic}.{story}-risk-{YYYYMMDD}.md
      template: risk-assessment-template.md
      description: Risk profile with probability × impact scoring
      agent: qa
      optional: true

    - location: docs/qa/assessments/{epic}.{story}-test-design-{YYYYMMDD}.md
      template: test-design-template.md
      description: Test strategy and coverage plan
      agent: qa
      optional: true

    - location: docs/qa/gates/{epic}.{story}-{slug}.yml
      description: Quality gate decision (PASS/CONCERNS/FAIL/WAIVED)
      agent: qa
      optional: true

  required:
    - docs/prd.md (or equivalent requirements)
    - docs/architecture.md (system design)
    - Sharded epic with story sequence

# ============================================================================
# VALIDATION
# ============================================================================

validation:
  success_criteria:
    - All acceptance criteria met
    - All tests passing (unit, integration, e2e)
    - Linting and type checking passing
    - Code review approved (if requested)
    - QA gate decision (if requested)
    - Changes committed to version control
    - Story marked as Done

  quality_gates:
    - name: Development Complete
      criteria:
        - All tasks marked complete
        - All tests passing
        - File List updated
        - Completion notes documented

    - name: Review Approved
      criteria:
        - User verified implementation
        - QA review passed (if requested)
        - All identified issues addressed

    - name: Ready to Deploy
      criteria:
        - Regression tests passing
        - Linting passing
        - Changes committed
        - Gate decision recorded (if applicable)

# ============================================================================
# DECISION TREES
# ============================================================================

decision_trees:
  project_type:
    question: "Do you have a large codebase or monorepo?"
    branches:
      - condition: "Yes"
        recommendation: "PRD-First Approach"
        notes: "Create PRD → Document only affected areas"

      - condition: "No - codebase well-known"
        recommendation: "PRD-First Approach"

      - condition: "No - codebase unknown"
        recommendation: "Document-First Approach"

  brownfield_workflow:
    question: "Is this a major enhancement affecting multiple systems?"
    branches:
      - condition: "Yes"
        recommendation: "Full Brownfield Workflow"
        required_steps:
          - risk_assessment
          - test_design
          - qa_review
        notes: "ALWAYS run Test Architect risk + design first"

      - condition: "No - more than simple bug fix"
        recommendation: "Brownfield Story Workflow"
        required_steps:
          - risk_assessment  # If touching integration points
          - qa_review
        notes: "Run *risk if touching critical paths"

      - condition: "No - simple bug fix"
        recommendation: "Standard Story Workflow"
        optional_steps:
          - qa_review  # Still recommended
        notes: "QA review recommended for quality assurance"

  legacy_code_decision:
    question: "Does the change touch legacy code?"
    branches:
      - condition: "Yes"
        recommendation: "Test Architect MANDATORY"
        required_steps:
          - risk_assessment  # Identify regression potential
          - test_design      # Plan test coverage
          - qa_review        # Validate no breakage

      - condition: "No"
        recommendation: "Test Architect RECOMMENDED"
        optional_steps:
          - qa_review  # Ensure quality standards

# ============================================================================
# BROWNFIELD SPECIFIC GUIDANCE
# ============================================================================

brownfield:
  when_mandatory:
    - Large codebase or monorepo modifications
    - Changes touching legacy code
    - API modifications or integrations
    - Data migrations
    - Performance-critical changes
    - Security-sensitive changes
    - Multiple system integrations

  required_steps:
    - risk_assessment: "BEFORE development starts"
    - test_design: "BEFORE writing code"
    - qa_review: "BEFORE merging"

  testing_standards:
    regression_coverage:
      - "Every touched legacy module needs tests"
      - "Minimum 80% coverage of affected code paths"
      - "Critical paths require 100% coverage"

    performance_baselines:
      - "Must maintain or improve current metrics"
      - "Document acceptable degradation thresholds"
      - "Include performance tests in CI/CD"

    rollback_procedures:
      - "Every change needs a rollback plan"
      - "Rollback must be tested"
      - "Document rollback triggers and process"

    feature_flags:
      - "All risky changes behind toggles"
      - "Test both enabled and disabled states"
      - "Document flag removal plan"

# ============================================================================
# PROGRESSIVE DISCLOSURE REFERENCES
# ============================================================================

progressive_disclosure:
  skill_structure:
    - level: core
      files:
        - skills/{agent}/SKILL.md
      size: "<2k tokens"
      purpose: "List available commands, quick reference"

    - level: detailed
      files:
        - skills/{agent}/reference/commands.md
        - skills/{agent}/reference/{topic}.md
      size: "Variable"
      purpose: "Detailed command instructions, loaded as needed"

    - level: specialized
      files:
        - skills/{agent}/reference/tasks/{task-name}.md
        - skills/{agent}/reference/checklists/{checklist-name}.md
      size: "Variable"
      purpose: "Specific task instructions, loaded when referenced"

  loading_pattern:
    - "Workflow references action (e.g., create-architecture)"
    - "Loads skills/{agent}/SKILL.md (core commands)"
    - "Progressively loads reference/*.md as needed"
    - "Only loads what's necessary for current step"

# ============================================================================
# NOTES
# ============================================================================

notes: |
  This workflow orchestrates the complete PRISM development cycle with flexibility
  for both greenfield and brownfield projects.

  KEY PRINCIPLES:

  1. **Adaptive Workflow**: Optional steps based on project risk and complexity
  2. **Progressive Disclosure**: Skills load detailed instructions as needed
  3. **Brownfield Safety**: Test Architect involvement for legacy code changes
  4. **Quality Gates**: Clear checkpoints with user control
  5. **PRISM Methodology**: All five principles applied throughout

  SKILL COMMAND MAPPING:

  All workflow actions map to commands defined in skills/{agent}/SKILL.md:
  - sm: draft, planning-review, decompose, estimate, resize
  - po: story-checklist, create-story, validate-story-draft, shard-doc
  - dev: develop-story, run-tests
  - qa: risk-profile, test-design, review, gate
  - architect: document-project, create-architecture

  Each command loads its core definition from SKILL.md, then progressively loads
  detailed instructions from reference/ directory as needed.

  BROWNFIELD DECISION FLOW:

  - High-risk story? → *risk + *design BEFORE coding
  - Before merge? → *review for comprehensive QA
  - After fixes? → *gate to update decision

  Use this workflow as the foundation for all PRISM development, adapting the
  optional steps based on project needs and risk assessment.

version: 1.1.0
